import res
from res.connectors.graphql.ResGraphQLClient import ResGraphQLClient


from tenacity import retry, stop_after_attempt, wait_fixed


class SkuPriceCostCalculator:

    GET_STYLES_PRICES = """
query GetStylesInvoice($after:String, $resonance_code_array: [WhereValue!]) {
   styles(first:100, after:$after, where:{code: {isAnyOf: $resonance_code_array}} ){
    count
    cursor
    styles{
      id
      code
      allProducts{
        wholesalePrice
        price
      }
    }
  }
}
"""

    GET_STYLES_COSTS = """
query GetStylesInvoice($after:String, $resonance_code_array: [WhereValue!]) {
   styles(first:100, after:$after, where:{code: {isAnyOf: $resonance_code_array}} ){
    count
    cursor
    styles{
      id
      code
      onePrices{
        cost
        size {
          code
        }
      }
    }
  }
}
"""
    test_skus_as_strings = """
TK-3119 CDCBM SWIMIJ 2ZZSM
TK-6121 PIMA7 SWIMJV 2ZZSM
CC-9018 OC135 SWIMIJ 0ZZOS
TK-6121 PIMA7 SWIMIJ 2ZZSM
CC-3066 CDCBM SWIMIJ 2ZZSM
CC-3066 CDCBM SWIMJV 2ZZSM
TK-6121 PIMA7 SWIMIJ 1ZZXS
TK-3119 CDCBM SWIMJV 3ZZMD
TK-3119 CDCBM SWIMJV 2ZZSM
CC-9018 OC135 SWIMJV 0ZZOS
TK-6121 PIMA7 SWIMJV 1ZZXS
CC-2099 CUTWL RAINQH Z3400
CC-2099 CUTWL RAINQH Z2800
CC-2031 CLTWL DOTTKH ZZZ06
CC-2031 CLTWL PSYCVP ZZZ14
CC-2066 HC293 JUICPU Z3900
BG-3005 CTNBA COLOJK 3ZZMD
BO-6000 CTNOX BRUNMU 4ZZLG
BG-3005 CTNBA COLOJK 3ZZMD
LA-6001 LN135 ELIZMM ZZZ04
LA-6009 LN135 KILIUK ZZZ06
LA-6013 LN135 DOTCMN ZZZZ0
LA-6009 LN135 KILIUK ZZZ02
LA-6013 LN135 DOTCMN ZZZ06
CC-3105 LN135 NEWDKG 1ZZXS
LA-6013 LN135 DOTCMN ZZZ02
CC-3105 LN135 NEWDKG 2ZZSM
LA-6013 LN135 DOTNZA ZZZ04
LA-6009 CHRST LAURUD ZZZZ0
LA-6001 LN135 ELIZMM ZZZ06
LA-6013 LN135 DOTNZA ZZZZ0
LA-6013 LN135 DOTNZA ZZZ02
LA-3001 LN135 BLACJL ZZZ02
LA-6009 CHRST LAURUD ZZZ02
LA-3001 LN135 BLACJL ZZZ04
LA-6001 LN135 ELIZMM ZZZ02
LA-6007 LN135 BLACQZ ZZZ04
LA-6009 LN135 KILIUK ZZZ08
LA-6009 LN135 KILIUK ZZZ04
LA-3001 LN135 BLACJL ZZZ06
LA-3001 LN135 BLACJL ZZZZ0
LA-6009 CHRST LAURUD ZZZ06
LA-6009 LN135 KILIUK ZZZZ0
LA-6007 LN135 BLACQZ ZZZ02
LA-6013 LN135 DOTCMN ZZZ04
LA-6007 LN135 BLACQZ ZZZ06
LA-6013 LN135 DOTNZA ZZZ06
CC-3105 LN135 NEWDKG 3ZZMD
LA-6009 CHRST LAURUD ZZZ04
TH-3003 PIMA7 NEONRH 2ZZSM
TH-3003 PIMA7 NEONRH 2ZZSM
CC-6008 LY115 BEHOSJ 0ZZXX
CC-6008 LY115 BEHOSJ 1ZZXS
CC-6008 LY115 BEHOSJ 2ZZSM
CC-6008 LY115 BEHOSJ 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
CC-2031 CLTWL DOTTKH ZZZ10
BG-3005 CTNBA COLOJK 4ZZLG
CC-3054 ECVIC SPRIMZ 6ZZ2X
CC-3066 CDCBM LAGOLZ 2ZZSM
TK-6166 PIMA7 NAVYGY 2ZZSM
CC-8081 MCTST LAGOEC 3ZZMD
TK-2052 CDCBM LAGOXO 3ZZMD
TK-2052 CDCBM LAGOXO 2ZZSM
TK-3100 CDCBM NAVYGY 2ZZSM
TK-2035 CDCBM SPTMRS 2ZZSM
TK-3113 PIMA7 LAGOOZ 2ZZSM
TK-6121 PIMA7 SWIMJV 2ZZSM
CC-3075 CDCBM LAGOSQ 2ZZSM
TK-6121 PIMA7 NAVYGY 2ZZSM
CC-8081 MCTST LAGOEC 2ZZSM
GS-3000 CFT97 CHERVK 4ZZLG
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
CC-2099 CUTWL RAINQH Z2800
AS-3001 CT170 HOUSGU 3ZZMD
AS-3001 CT170 HOUSGU 4ZZLG
AS-3001 CT170 HOUSGU 2ZZSM
AS-3001 CT170 LOVEFY 2ZZSM
AS-3001 CT170 LOVEFY 4ZZLG
AS-3001 CT170 LOVEFY 3ZZMD
AS-3001 CT170 WESBBT 3ZZMD
AS-3001 CT170 WESBBT 4ZZLG
AS-3001 CT170 WESBBT 2ZZSM
CC-4022 FBTRY ETERFG 3ZZMD
CC-4022 FBTRY ETERFG 2ZZSM
CC-4022 FBTRY ETERFG 4ZZLG
CC-3042 CTNBA ACSEXQ 2ZZSM
CC-3042 CTNBA ACSEXQ 3ZZMD
CC-3042 CTNBA ACSEXQ 4ZZLG
AS-3001 CT170 COMESR 4ZZLG
AS-3001 CT170 COMESR 3ZZMD
AS-3001 CT170 COMESR 2ZZSM
AS-3001 CT170 FROGFK 2ZZSM
AS-3001 CT170 FROGFK 4ZZLG
AS-3001 CT170 FROGFK 3ZZMD
CC-3105 LTCSL BARAPV 2ZZSM
CC-3105 LTCSL BARAPV 3ZZMD
CC-3105 LTCSL BARAPV 1ZZXS
CC-3105 LTCSL BARAPV 0ZZXX
CC-3105 LTCSL BARAPV 4ZZLG
CC-3068 PIQUE FROGPN 2ZZSM
CC-3068 PIQUE FROGPN 3ZZMD
CC-3068 PIQUE FROGPN 4ZZLG
CC-3052 CTF19 ACSLXB 3ZZMD
CC-3052 CTF19 ACSLXB 2ZZSM
CC-3052 CTF19 ACSLXB 4ZZLG
CC-3055 TNCDO PRESOV 4ZZLG
CC-3055 TNCDO PRESOV 3ZZMD
CC-3055 TNCDO PRESOV 2ZZSM
AS-3001 CT170 BLACOS 4ZZLG
AS-3001 CT170 BLACOS 2ZZSM
AS-3001 CT170 BLACOS 3ZZMD
CC-9024 CT406 ACSLEY 0ZZOS
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
LA-6013 LN135 KILIKV ZZZZ0
LA-6013 LN135 KILIKV ZZZ06
LA-6013 LN135 KILIKV ZZZ02
LA-6013 LN135 KILIKV ZZZ04
LA-6009 LSC19 BLACVK ZZZZ0
LA-6009 LSC19 BLACVK ZZZ04
LA-6009 LSC19 BLACVK ZZZ08
LA-6009 LSC19 BLACVK ZZZ02
LA-6009 LSC19 BLACVK ZZZ06
CC-3079 CDCBM BLACVK 0ZZXX
CC-3079 CDCBM BLACVK 2ZZSM
CC-3079 CDCBM BLACVK 1ZZXS
CC-3079 CDCBM BLACVK 3ZZMD
LA-6009 LN135 DOTSYT ZZZ08
LA-6009 LN135 DOTSYT ZZZ06
LA-6009 LN135 DOTSYT ZZZ02
LA-6009 LN135 DOTSYT ZZZ04
LA-6009 LN135 BURLJG ZZZ04
LA-6009 LN135 BURLJG ZZZ08
LA-6009 LN135 BURLJG ZZZ02
LA-6009 LN135 BURLJG ZZZ06
LA-6009 LN135 BURLJG ZZZZ0
LA-6009 LN135 KILIZE ZZZ04
LA-6009 LN135 KILIZE ZZZ02
LA-6009 LN135 KILIZE ZZZ06
LA-6009 LN135 KILIZE ZZZ08
NA-1001 LY100 CREAPB 2ZZSM
NA-6002 LY100 BLACYG 2ZZSM
NA-6002 LSG19 BLACFY 2ZZSM
NA-3006 LY100 GREEOV 2ZZSM
NA-1001 LSC19 RUSTSV 2ZZSM
NA-2003 LY100 GREEKJ 2ZZSM
NA-3006 LY100 BLACFT 2ZZSM
NA-4000 LY100 WHITZQ 2ZZSM
NA-3005 RYJ01 RUSTNO 2ZZSM
NA-4000 RYJ01 GREEZT 2ZZSM
NA-2002 RYJ01 RUSTBQ 2ZZSM
NA-2002 RYJ01 BLACWZ 2ZZSM
NA-4000 LY100 WHITZQ 2ZZSM
NA-6002 LSG19 BLACFY 2ZZSM
NA-6002 LY100 BLACYG 2ZZSM
NA-4000 RYJ01 GREEZT 2ZZSM
NA-2002 RYJ01 BLACWZ 2ZZSM
NA-3005 RYJ01 RUSTNO 2ZZSM
NA-3006 LY100 BLACFT 2ZZSM
NA-2003 LY100 GREEKJ 2ZZSM
NA-1001 LY100 CREAPB 2ZZSM
NA-2002 RYJ01 RUSTBQ 2ZZSM
NA-1001 LSC19 RUSTSV 2ZZSM
NA-3006 LY100 GREEOV 2ZZSM
CC-9009 PIMA7 LOGOJY 0ZZOS
TT-3036 CTW70 CITRBQ 1ZZXS
LA-6009 LN135 DOTSYT ZZZ02
LA-6009 LN135 DOTSYT ZZZ06
LA-6009 LN135 DOTSYT ZZZ08
LA-6009 LN135 DOTSYT ZZZ04
LA-6009 LN135 BURLJG ZZZ08
LA-6009 LN135 BURLJG ZZZ02
LA-6009 LN135 BURLJG ZZZ06
LA-6009 LN135 BURLJG ZZZ04
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
CC-9011 CC254 UPDAUJ 0ZZOS
DJ-6001 CTNBA CHARUR 3ZZMD
DJ-6001 CTNBA BLACPV 5ZZXL
DJ-6001 CTNBA MARBLY 3ZZMD
DJ-6001 CTNBA BLACPV 3ZZMD
DJ-6001 CTNBA CHARUR 2ZZSM
DJ-6001 CTNBA CHARUR 5ZZXL
DJ-6001 CTNBA ABSTZT 2ZZSM
DJ-6001 CTNBA ABSTZT 7ZZ3X
DJ-6001 CTNBA CHARUR 7ZZ3X
DJ-6001 CTNBA ABSTZT 6ZZ2X
DJ-6001 CTNBA MARBLY 4ZZLG
DJ-6001 CTNBA MARBLY 2ZZSM
DJ-6001 CTNBA DOARMT 3ZZMD
DJ-6001 CTNBA CHARUR 8ZZ4X
DJ-6001 CTNBA DOARMT 4ZZLG
DJ-6001 CTNBA MARBLY 7ZZ3X
DJ-6001 CTNBA MARBLY 8ZZ4X
DJ-6001 CTNBA ABSTZT 3ZZMD
DJ-6001 CTNBA DOARMT 7ZZ3X
DJ-6001 CTNBA CHARUR 4ZZLG
DJ-6001 CTNBA BLACPV 2ZZSM
DJ-6001 CTNBA DOARMT 6ZZ2X
DJ-6001 CTNBA DOARMT 8ZZ4X
DJ-6001 CTNBA BLACPV 8ZZ4X
DJ-6001 CTNBA BLACPV 7ZZ3X
DJ-6001 CTNBA DOARMT 2ZZSM
DJ-6001 CTNBA BLACPV 6ZZ2X
DJ-6001 CTNBA CHARUR 6ZZ2X
DJ-6001 CTNBA ABSTZT 4ZZLG
DJ-6001 CTNBA ABSTZT 5ZZXL
DJ-6001 CTNBA ABSTZT 8ZZ4X
DJ-6001 CTNBA BLACPV 4ZZLG
DJ-6001 CTNBA MARBLY 5ZZXL
DJ-6001 CTNBA DOARMT 5ZZXL
DJ-6001 CTNBA MARBLY 6ZZ2X
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
CC-4004 CLTWL LARGUS 2ZZSM
CC-1022 OCT70 PRARKA ZZZ04
CC-1022 OCT70 REDDCA ZZZ04
TT-3072 CTNBA SELF-- 3ZZMD
KT-3038 CTNBA MAGEDU 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TT-3072 CTNBA SELF-- 3ZZMD
TK-6166 SLCTN REDPWI 2ZZSM
TK-6003 LY115 CRIMNU 2ZZSM
TK-3119 CDCBM BLACJX 2ZZSM
TK-2054 CDCBM VIBRVF 3ZZMD
TK-2034 CDCBM RETRZY 3ZZMD
TK-6166 SLCTN REDPWI 3ZZMD
TK-6166 CDCBM PLACZN 3ZZMD
TK-6166 CDCBM PLACZN 2ZZSM
TK-6003 LY115 CRIMNU 3ZZMD
TK-6003 CDCBM DESAHV 4ZZLG
TK-2052 CHRST RETRTX 3ZZMD
TK-6129 PIMA7 BLACCY 3ZZMD
TK-1007 CHRST TUCKUC 2ZZSM
CC-3075 CDCBM WIDEXA 2ZZSM
CC-3066 CHRST CRIMLS 3ZZMD
TK-6168 CDCBM SOPHRH 3ZZMD
TK-6129 PIMA7 BLACCY 4ZZLG
TK-6003 PIMA7 LAGOJB 2ZZSM
TK-2054 CDCBM BLACAC 4ZZLG
TK-2052 CDCBM WIDEXA 3ZZMD
TK-2034 CDCBM WIDEXA 4ZZLG
TK-1007 CHRST TUCKUC 1ZZXS
TK-2054 CDCBM VIBRVF 4ZZLG
CC-3075 CDCBM WIDEXA 4ZZLG
CC-3075 CDCBM WIDEXA 3ZZMD
CC-3066 CHRST CRIMLS 2ZZSM
TK-6168 CDCBM SOPHRH 5ZZXL
TK-2034 CDCBM WIDEXA 3ZZMD
TK-2034 CDCBM RETRZY 4ZZLG
TK-6003 CDCBM DESAYE 3ZZMD
TK-2034 CDCBM WIDEXA 2ZZSM
TK-2054 CDCBM BLACAC 3ZZMD
TK-6003 CDCBM DESAHV 3ZZMD
TK-6121 LY115 GLIDXG 3ZZMD
TK-6003 PIMA7 LAGOJB 3ZZMD
TK-2054 CDCBM BLACAC 5ZZXL
TH-6004 PIMA7 SFLODX 4ZZLG
TH-6004 PIMA7 SFLODX 3ZZMD
TH-6004 PIMA7 SFLODX 1ZZXS
TH-6004 PIMA7 SFLODX 2ZZSM
TH-6004 PIMA7 SFLODX 0ZZXX
TH-6004 PIMA7 SFLODX 5ZZXL
TH-6004 PIMA7 SFLODX 3ZZMD
TH-6004 PIMA7 SFLODX 5ZZXL
TH-6004 PIMA7 SFLODX 4ZZLG
TH-6004 PIMA7 SFLODX 6ZZ2X
JR-3060 PIMA7 SAMUXG 4ZZLG
CC-9009 PIMA7 THEMFZ 0ZZOS
CC-9004 SLCTN DUSTNT 0ZZOS
TH-6004 PIMA7 WHITOI 2ZZSM
TH-6004 PIMA7 WHITOI 4ZZLG
TH-6004 PIMA7 WHITOI 5ZZXL
TH-6004 PIMA7 WHITOI 3ZZMD
CC-9009 PIMA7 THEMFZ 0ZZOS
TH-6005 CHRST OMBRUP 5ZZXL
TH-6005 CHRST OMBRUP 6ZZ2X
TH-6005 CHRST OMBRUP 3ZZMD
TH-6005 CHRST OMBRUP 4ZZLG
TH-6004 PIMA7 SFLONZ 5ZZXL
TH-6004 PIMA7 SFLONZ 6ZZ2X
TH-6004 PIMA7 SFLONZ 2ZZSM
TH-6004 PIMA7 SFLONZ 3ZZMD
TH-6004 PIMA7 SFLONZ 4ZZLG
TH-1002 PIMA7 OMBRLQ 3ZZMD
TH-1002 PIMA7 OMBRLQ 2ZZSM
TH-1002 PIMA7 OMBRLQ 1ZZXS
TH-1002 PIMA7 OMBRLQ 4ZZLG
TH-6005 CHRST OMBRVY 0ZZXX
TH-6005 CHRST OMBRVY 1ZZXS
TH-6005 CHRST OMBRVY 5ZZXL
TH-6005 CHRST OMBRVY 6ZZ2X
TH-6005 CHRST OMBRVY 4ZZLG
TH-6005 CHRST OMBRVY 2ZZSM
TH-6005 CHRST OMBRVY 3ZZMD
TH-6005 CHRST RAINTV 2ZZSM
TH-6005 CHRST RAINTV 3ZZMD
TH-6005 CHRST RAINTV 1ZZXS
TH-6005 CHRST RAINTV 0ZZXX
TH-6005 CHRST RAINTV 4ZZLG
TH-6005 CHRST DIPDVV 3ZZMD
TH-6005 CHRST DIPDVV 5ZZXL
TH-6005 CHRST DIPDVV 6ZZ2X
TH-6005 CHRST DIPDVV 4ZZLG
TH-6005 CHRST DIPDVV 2ZZSM
TH-3003 PIMA7 OMBRLQ 1ZZXS
TH-3003 PIMA7 OMBRLQ 4ZZLG
TH-3003 PIMA7 OMBRLQ 3ZZMD
TH-3003 PIMA7 OMBRLQ 2ZZSM
TH-6004 CTW70 PURPBR 2ZZSM
TH-6004 CTW70 PURPBR 0ZZXX
TH-6004 CTW70 PURPBR 4ZZLG
TH-6004 CTW70 PURPBR 3ZZMD
TH-6004 CTW70 PURPBR 5ZZXL
TH-6004 CTW70 PURPBR 1ZZXS
TH-6004 PIMA7 NEONLG 3ZZMD
TH-6004 PIMA7 NEONLG 2ZZSM
TH-6004 PIMA7 NEONLG 4ZZLG
TH-6004 PIMA7 NEONLG 5ZZXL
TH-6004 PIMA7 GINGCK 6ZZ2X
TH-6004 PIMA7 GINGCK 3ZZMD
TH-6004 PIMA7 GINGCK 4ZZLG
TH-6004 PIMA7 GINGCK 5ZZXL
TH-6004 PIMA7 BLUEYJ 5ZZXL
TH-6004 PIMA7 BLUEYJ 4ZZLG
TH-6004 PIMA7 BLUEYJ 3ZZMD
TH-6004 PIMA7 BLUEYJ 6ZZ2X
TH-6004 PIMA7 DIPDVV 3ZZMD
TH-6004 PIMA7 DIPDVV 6ZZ2X
TH-6004 PIMA7 DIPDVV 4ZZLG
TH-6004 PIMA7 DIPDVV 2ZZSM
TH-6004 PIMA7 DIPDVV 5ZZXL
TH-6004 PIMA7 PINKIC 5ZZXL
TH-6004 PIMA7 PINKIC 6ZZ2X
TH-6004 PIMA7 PINKIC 3ZZMD
TH-6004 PIMA7 PINKIC 4ZZLG
TH-6004 PIMA7 RAINHM 4ZZLG
TH-6004 PIMA7 RAINHM 5ZZXL
TH-6004 PIMA7 RAINHM 6ZZ2X
TH-6004 PIMA7 RAINHM 3ZZMD
TH-6003 CTNPT SELF-- 5ZZXL
TH-6003 CTNPT SELF-- 4ZZLG
TH-6003 CTNPT SELF-- 3ZZMD
TH-6003 CTNPT SELF-- 2ZZSM
TH-6003 CTNBA RAINHM 1ZZXS
TH-6003 CTNBA RAINHM 3ZZMD
TH-6003 CTNBA RAINHM 4ZZLG
TH-6003 CTNBA RAINHM 2ZZSM
TH-4000 CLTWL OMBRVY 4ZZLG
TH-4000 CLTWL OMBRVY 5ZZXL
TH-4000 CLTWL OMBRVY 0ZZXX
TH-4000 CLTWL OMBRVY 6ZZ2X
TH-4000 CLTWL OMBRVY 2ZZSM
TH-4000 CLTWL OMBRVY 1ZZXS
TH-4000 CLTWL OMBRVY 3ZZMD
TH-4000 CLTWL DIPDVV 4ZZLG
TH-4000 CLTWL DIPDVV 5ZZXL
TH-4000 CLTWL DIPDVV 3ZZMD
TH-4000 CLTWL DIPDVV 2ZZSM
TH-3003 PIMA7 WHITOI 2ZZSM
TH-3003 PIMA7 WHITOI 5ZZXL
TH-3003 PIMA7 WHITOI 3ZZMD
TH-3003 PIMA7 WHITOI 4ZZLG
TH-3003 PIMA7 WHITOI 1ZZXS
TH-3003 PIMA7 YELLBY 3ZZMD
TH-3003 PIMA7 YELLBY 2ZZSM
TH-3003 PIMA7 YELLBY 5ZZXL
TH-3003 PIMA7 YELLBY 4ZZLG
TH-3003 PIMA7 YELLBY 1ZZXS
TH-6001 PIMA7 SFLODE 1ZZXS
TH-6001 PIMA7 SFLODE 2ZZSM
TH-6001 PIMA7 SFLODE 6ZZ2X
TH-6001 PIMA7 SFLODE 3ZZMD
TH-6001 PIMA7 SFLODE 4ZZLG
TH-6001 PIMA7 SFLODE 5ZZXL
TH-6001 PIMA7 LIGHPU 4ZZLG
TH-6001 PIMA7 LIGHPU 5ZZXL
TH-6001 PIMA7 LIGHPU 2ZZSM
TH-6001 PIMA7 LIGHPU 3ZZMD
TH-6001 PIMA7 WATEBJ 2ZZSM
TH-6001 PIMA7 WATEBJ 3ZZMD
TH-6001 PIMA7 WATEBJ 4ZZLG
TH-6003 CTNBA RAINHM 3ZZMD
TH-6003 CTNBA RAINHM 2ZZSM
TH-6003 CTNBA RAINHM 4ZZLG
TH-6003 CTNBA RAINHM 1ZZXS
TH-3003 PIMA7 NEONRH 5ZZXL
TH-3003 PIMA7 NEONRH 4ZZLG
TH-3003 PIMA7 NEONRH 2ZZSM
TH-3003 PIMA7 NEONRH 0ZZXX
TH-3003 PIMA7 NEONRH 1ZZXS
TH-3003 PIMA7 NEONRH 3ZZMD
TH-3003 PIMA7 LIGHKZ 1ZZXS
TH-3003 PIMA7 LIGHKZ 2ZZSM
TH-3003 PIMA7 LIGHKZ 3ZZMD
TH-3003 PIMA7 LIGHKZ 5ZZXL
TH-3003 PIMA7 LIGHKZ 4ZZLG
TH-3003 PIMA7 NEONLG 5ZZXL
TH-3003 PIMA7 NEONLG 4ZZLG
TH-3003 PIMA7 NEONLG 2ZZSM
TH-3003 PIMA7 NEONLG 1ZZXS
TH-3003 PIMA7 NEONLG 3ZZMD
TH-3003 PIMA7 OMBRLQ 1ZZXS
TH-3003 PIMA7 OMBRLQ 2ZZSM
TH-3003 PIMA7 OMBRLQ 0ZZXX
TH-3003 PIMA7 OMBRLQ 3ZZMD
TH-3003 PIMA7 PASTNI 5ZZXL
TH-3003 PIMA7 PASTNI 3ZZMD
TH-3003 PIMA7 PASTNI 4ZZLG
TH-3003 PIMA7 PASTNI 6ZZ2X
TH-3003 PIMA7 SFLODE 2ZZSM
TH-3003 PIMA7 SFLODE 3ZZMD
TH-3003 PIMA7 SFLODE 1ZZXS
TH-3003 PIMA7 SFLODE 0ZZXX
TH-3003 PIMA7 SFLODE 4ZZLG
TH-3003 PIMA7 PINKUM 2ZZSM
TH-3003 PIMA7 PINKUM 3ZZMD
TH-3003 PIMA7 PINKUM 4ZZLG
TH-3003 PIMA7 OMBRVY 0ZZXX
TH-3003 PIMA7 OMBRVY 1ZZXS
TH-3003 PIMA7 OMBRVY 2ZZSM
TH-3002 PIMA7 OMBRVY 6ZZ2X
TH-3002 PIMA7 OMBRVY 4ZZLG
TH-3002 PIMA7 OMBRVY 5ZZXL
TH-3002 PIMA7 OMBRVY 1ZZXS
TH-3002 PIMA7 OMBRVY 2ZZSM
TH-3002 PIMA7 OMBRVY 3ZZMD
TH-3002 PIMA7 SFLODE 1ZZXS
TH-3002 PIMA7 SFLODE 2ZZSM
TH-3002 PIMA7 SFLODE 5ZZXL
TH-3002 PIMA7 SFLODE 4ZZLG
TH-3002 PIMA7 SFLODE 3ZZMD
TH-3000 PIMA7 YELLOW 2ZZSM
TH-3000 PIMA7 YELLOW 3ZZMD
TH-3000 PIMA7 YELLOW 1ZZXS
TH-3000 PIMA7 YELLOW 4ZZLG
TH-3000 PIMA7 YELLOW 5ZZXL
TH-3000 PIMA7 WHITOJ 5ZZXL
TH-3000 PIMA7 WHITOJ 2ZZSM
TH-3000 PIMA7 WHITOJ 3ZZMD
TH-3000 PIMA7 WHITOJ 4ZZLG
TH-3003 PIMA7 FADEOR 2ZZSM
TH-3003 PIMA7 FADEOR 3ZZMD
TH-3003 PIMA7 FADEOR 1ZZXS
TH-3003 PIMA7 FADEOR 4ZZLG
TH-3003 PIMA7 FADEOR 5ZZXL
TH-3003 PIMA7 BLUEYJ 4ZZLG
TH-3003 PIMA7 BLUEYJ 3ZZMD
TH-3003 PIMA7 BLUEYJ 2ZZSM
TH-3003 CTW70 DIPDNX 5ZZXL
TH-3003 CTW70 DIPDNX 2ZZSM
TH-3003 CTW70 DIPDNX 4ZZLG
TH-3003 CTW70 DIPDNX 3ZZMD"""

    # nudge
    def _generate_list_of_skus(self):
        # Splitting the data into lines
        lines = self.test_skus_as_strings.split("\n")

        # Processing each line
        processed_lines = [s for s in lines if s]
        return processed_lines

    def _get_decontructed_sku_list(self, sku_array):
        sku_info_list = []
        for sku in sku_array:
            sku = sku.strip()
            string_code = ""
            base_object = {}
            base_object["sku"] = sku
            each_sku_element = (sku.strip()).split(" ")
            string_code = each_sku_element[0]
            for element in each_sku_element[1:-1]:
                string_code += " " + element
            base_object["code"] = string_code
            base_object["size"] = each_sku_element[-1]
            sku_info_list.append(base_object)

        return sku_info_list

    # this needs a retrier cos graphql is a heap of shit...
    @retry(wait=wait_fixed(1), stop=stop_after_attempt(4), reraise=True)
    def graph_query_with_retry(self, graphql_client, query, chunk):
        data_styles_invoices = graphql_client.query(
            query,
            {"resonance_code_array": chunk, "after": "0"},
        )

        if not (data_styles_invoices and "data" in data_styles_invoices):
            raise Exception(
                f"data_styles_invoices came back empty from price query {query}"
            )
        else:
            return data_styles_invoices["data"]  #

    def get_cost_price_info_for_skus(self, sku_list, is_prices):
        """
        This function, given a list of skus, will get retail, wholesale and cost info for that list. returned as a dict with sku as the key.
        Bear in mind that not all skus might be found, or cost could be null, or both retail and wholesale might be zero and null(this last one is very common)
        Skus should be in format: 'RB-6018 PIMA7 NATUQX 0ZZXX'
        """
        import pandas as pd

        graphql_client = ResGraphQLClient()

        # break down the skus in to a list of dicts with sku as key and code and size as values in dict #
        sku_broken_down_list = self._get_decontructed_sku_list(sku_list)

        # now get all the styles, we need this for the query
        all_styles_array = [
            style_sku_info["code"] for style_sku_info in sku_broken_down_list
        ]

        code_to_skus_lookup = {}
        for item in sku_broken_down_list:
            code = item["code"]
            sku = item["sku"]
            code_to_skus_lookup.setdefault(code, []).append(sku)

        res.utils.logger.info(
            f"Requesting ({len(all_styles_array)}) unique style codes"
        )
        # remove dupes
        all_styles_array = list(set(all_styles_array))
        pricing_lookup_sku = {}

        # because createOneAPI is slow, you need to chunk the style codes into small chunks or you'll get timeouts
        chunk_size = 50
        for i in range(0, len(all_styles_array), chunk_size):
            chunk = all_styles_array[i : i + chunk_size]

            res.utils.logger.info(f"Requesting ({i} to  {i + chunk_size}) from graphQL")
            query_to_use = (
                self.GET_STYLES_PRICES if is_prices else self.GET_STYLES_COSTS
            )
            data_styles_invoices = self.graph_query_with_retry(
                graphql_client, query_to_use, chunk
            )

            # now we take the mess of a dict that the graphQL query returns and create a succint dict to return to only show our 3 values (cost, retail, wholesale)

            res.utils.logger.info(
                f"retuned count: {len(data_styles_invoices['styles']['styles'])}"
            )
            for style in data_styles_invoices["styles"]["styles"]:
                if is_prices:
                    code = style["code"]

                    for sku in code_to_skus_lookup[code]:

                        wholesalePrice = style.get("allProducts")[0].get(
                            "wholesalePrice"
                        )
                        retailPrice = style.get("allProducts")[0].get("price")

                        pricing_lookup_sku[sku] = {
                            "wholesaleprice": wholesalePrice,
                            "retailprice": retailPrice,
                        }
                else:
                    for onePrice in style["onePrices"]:
                        sizeCode = onePrice.get("size").get("code")
                        sku = style["code"] + " " + sizeCode

                        cost = round(onePrice.get("cost"), 2)

                        pricing_lookup_sku[sku] = {"cost": cost}

        # the next couple of steps are not essential, just capturing some stats to report what could / could not be found
        pricing_lookup_sku = {
            k: v for k, v in pricing_lookup_sku.items() if k in sku_list
        }
        skus_returned_graphql = set([sku for sku in pricing_lookup_sku.keys()])

        skus_requested = set(sku_list)
        skus_not_returned = skus_requested.difference(skus_returned_graphql)
        res.utils.logger.info(
            f"Skus missing from results: ({len(skus_not_returned)}) {skus_not_returned}"
        )

        # delete the extra stuff the graph has returned to us

        df = pd.DataFrame(
            [
                {
                    "sku": k,
                    "retailprice": v.get("retailprice"),
                    "wholesaleprice": v.get("wholesaleprice"),
                    "cost": v.get("cost"),
                }
                for k, v in pricing_lookup_sku.items()
            ]
        )
        return df


if __name__ == "__main__":

    pricecalc = SkuPriceCostCalculator()
    skus = pricecalc._generate_list_of_skus()

    d = pricecalc.get_cost_price_info_for_skus(skus)
    res.utils.logger.info(res.utils.safe_json_dumps(d))
